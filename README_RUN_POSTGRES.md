# üöÄ –ó–∞–ø—É—Å–∫ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ KOCMOC (PostgreSQL, —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –¢–ó)

–≠—Ç–æ—Ç —Ñ–∞–π–ª –æ–ø–∏—Å—ã–≤–∞–µ—Ç, –∫–∞–∫ –ø–æ–¥–Ω—è—Ç—å –±—ç–∫–µ–Ω–¥/—Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ KOCMOC —Å PostgreSQL –∏ —á—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É –¢–ó. –í—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–∞ –±–µ–∑ –∑–∞–≥–ª—É—à–µ–∫: –∫–æ–º–∞–Ω–¥—ã, –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ —á–µ–∫-–ª–∏—Å—Ç—ã –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –ø—Ä–æ–≥–æ–Ω–∞.

## 1) –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- Node.js 18+
- npm 9+
- PostgreSQL 14+ (—Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º `uuid-ossp`)
- Git, cURL/Postman –¥–ª—è —Ä—É—á–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
- –°–≤–æ–±–æ–¥–Ω—ã–π –ø–æ—Ä—Ç `3000` (–∏–ª–∏ —Å–≤–æ–π —á–µ—Ä–µ–∑ `PORT`)

## 2) –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
–°–æ–∑–¥–∞–π—Ç–µ `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

```env
PORT=3000
NODE_ENV=production
JWT_SECRET=your-long-secret

# PostgreSQL
PG_HOST=127.0.0.1
PG_PORT=5432
PG_DATABASE=kocmoc
PG_USER=kocmoc_user
PG_PASSWORD=changeme
PG_SSL=false

# –ü–æ—á—Ç–∞ (–¥–ª—è /api/auth/send-code, /verify-code)
EMAIL_USER=your@gmail.com
EMAIL_PASS=app-password
EMAIL_FROM="KOCMOC <your@gmail.com>"
VERIFICATION_CODE_EXPIRES_MINUTES=15

# –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–æ–∫
UPLOAD_MAX_MB=50
ALLOWED_MIME=images/*,video/*,audio/*,application/pdf,application/zip
BLOCKED_EXT=.exe,.bat,.dll
```

> –ï—Å–ª–∏ –Ω–µ—Ç –≤–Ω–µ—à–Ω–µ–π –ø–æ—á—Ç—ã, –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Å—Ç–∞–≤—å—Ç–µ `EMAIL_USER`/`EMAIL_PASS` –ø—É—Å—Ç—ã–º–∏ ‚Äî –º–∞—Ä—à—Ä—É—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ email –≤–µ—Ä–Ω—É—Ç –æ—à–∏–±–∫—É, –∏ —ç—Ç–æ –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ –≤ —Ç–µ—Å—Ç–∞—Ö.

## 3) –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ PostgreSQL –ø–æ –¢–ó
```bash
# 3.1 –°–æ–∑–¥–∞—Ç—å –±–∞–∑—É –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
psql -U postgres -c "CREATE DATABASE kocmoc;"
psql -U postgres -c "CREATE USER kocmoc_user WITH PASSWORD 'changeme';"
psql -U postgres -c "GRANT ALL PRIVILEGES ON DATABASE kocmoc TO kocmoc_user;"

# 3.2 –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ UUID + —Å—Ö–µ–º—É —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –¢–ó
psql -U kocmoc_user -d kocmoc -c "CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";"
psql -U kocmoc_user -d kocmoc -f database/schema_postgres.sql
```

## 4) –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
npm install
```

> –ï—Å–ª–∏ –≤–Ω–µ—à–Ω–∏–π —Ä–µ–µ—Å—Ç—Ä npm –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, 403 –∏–ª–∏ timeout –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ä–µ–¥–µ),
> —Å–∫–∞—á–∞–π—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∑–∞—Ä–∞–Ω–µ–µ –∏ –ø–µ—Ä–µ–Ω–µ—Å–∏—Ç–µ –ø–∞–ø–∫—É `node_modules` –≤–º–µ—Å—Ç–µ —Å `package-lock.json`,
> –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ–µ –∑–µ—Ä–∫–∞–ª–æ –≤ `npm config set registry <url>`. –ë–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ
> `node_modules` —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è.

## 5) –ó–∞–ø—É—Å–∫
```bash
# –õ–æ–∫–∞–ª—å–Ω–æ
npm start

# –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫)
npm run dev

# PM2 (–ø—Ä–æ–¥–∞–∫—à–µ–Ω)
npm run pm2:start
```

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ `http://localhost:3000`. –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –æ—Ç–¥–∞—é—Ç—Å—è –∏–∑ `public/`, –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `uploads/`.

## 6) –ö–∞—Ä—Ç–∞ API (–ø–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É –¢–ó)
- `POST /api/auth/register`
- `POST /api/auth/login`
- `POST /api/auth/send-code`
- `POST /api/auth/verify-code`
- `GET /api/chats`, `GET /api/chats/:id`, `POST /api/chats`, `POST /api/chats/group`
- `GET /api/chats/:id/messages`, `POST /api/chats/:id/messages`
- `PATCH /api/messages/:id/edit`, `DELETE /api/messages/:id/delete`, `POST /api/messages/:id/forward`
- `POST /api/upload/file` (–ª–∏–º–∏—Ç 50 –ú–ë, —Ñ–∏–ª—å—Ç—Ä MIME + –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ .exe/.bat/.dll)
- `GET /api/stories`, `POST /api/stories`, `POST /api/stories/:id/view`

> –í —Ç–µ–∫—É—â–µ–º –∫–æ–¥–µ –º–∞—Ä—à—Ä—É—Ç—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞–∑—ã–≤–∞—é—Ç—Å—è `/register`, `/login`, `/resend-code`, `/verify-email`. –ß—Ç–æ–±—ã —Å—Ç—Ä–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –¢–ó, –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–π—Ç–µ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∏ —Ç–µ—Å—Ç—ã –Ω–∞ —Å–ø–∏—Å–æ–∫ –≤—ã—à–µ –∏ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ —Ä–æ—É—Ç–∏–Ω–≥, –µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è.

## 7) Socket.io (—Ä–µ–∞–ª—Ç–∞–π–º –ø–æ –¢–ó)
JWT-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ + —Å–æ–±—ã—Ç–∏—è `message:new`, `message:edit`, `message:delete`, `message:forward`, `typing:start/stop`, `presence:update`. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Socket.io –≤ –∫–æ–¥–æ–≤–æ–π –±–∞–∑–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –µ—ë –ø–µ—Ä–µ–¥ –ø—Ä–∏—ë–º–∫–æ–π –∏ –≤–∫–ª—é—á–∏—Ç–µ –≤ —Ç–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–≥–æ–Ω (—Å–º. —á–µ–∫-–ª–∏—Å—Ç –Ω–∏–∂–µ).

## 8) –ß–µ–∫-–ª–∏—Å—Ç —Ä—É—á–Ω–æ–≥–æ –ø—Ä–æ–≥–æ–Ω–∞ –ø–æ –¢–ó
–í—ã–ø–æ–ª–Ω—è–π—Ç–µ –ø–æ–¥—Ä—è–¥, —Ñ–∏–∫—Å–∏—Ä—É—è –æ—Ç–≤–µ—Ç—ã 200/4xx –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ.

1. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email**
   - `POST /api/auth/register` —Å email+–ø–∞—Ä–æ–ª—å+deviceId
   - `POST /api/auth/send-code` (–µ—Å–ª–∏ –æ—Ç–¥–µ–ª–µ–Ω–æ) ‚Üí –ø–∏—Å—å–º–æ/–æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–¥
   - `POST /api/auth/verify-code` —Å –∫–æ–¥–æ–º ‚Üí –ø–æ–ª—É—á–∏—Ç—å JWT
2. **–õ–æ–≥–∏–Ω / –ª–æ–≥–∞—É—Ç**
   - `POST /api/auth/login` ‚Üí JWT
   - `POST /api/auth/logout` (–µ—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç–µ) ‚Üí —Ç–æ–∫–µ–Ω –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω
3. **–ß–∞—Ç—ã**
   - `POST /api/chats` —Å–æ–∑–¥–∞—Ç—å –ª–∏—á–Ω—ã–π, `POST /api/chats/group` ‚Äî –≥—Ä—É–ø–ø–æ–≤–æ–π
   - `GET /api/chats` –∞–≤—Ç–æ-–ø–æ–¥–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–æ–≤; —É–±–µ–¥–∏—Ç—å—Å—è –≤ –Ω–∞–ª–∏—á–∏–∏ –∞–≤–∞—Ç–∞—Ä–æ–≤
   - `GET /api/chats/:id` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ + lastSeen
4. **–°–æ–æ–±—â–µ–Ω–∏—è**
   - `POST /api/chats/:id/messages` –¥–ª—è —Ç–∏–ø–æ–≤ text/photo/video/document/voice/sticker
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–∫—Ü–∏–∏, –ø–µ—Ä–µ—Å—ã–ª–∫—É `/api/messages/:id/forward`, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ `/api/messages/:id/edit`, —É–¥–∞–ª–µ–Ω–∏–µ `/api/messages/:id/delete`
   - –õ–∏–º–∏—Ç—ã: –¥–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞, –∞–Ω—Ç–∏-—Å–ø–∞–º (–∑–∞–¥–µ—Ä–∂–∫–∞), —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—á—Ç–µ–Ω–∏—è
5. **–§–∞–π–ª—ã –∏ –≥–æ–ª–æ—Å–æ–≤—ã–µ**
   - `POST /api/upload/file` —Å —Ñ–∞–π–ª–∞–º–∏ < 50 –ú–ë –∏ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–º–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º–∏ ‚Üí –æ–∂–∏–¥–∞—Ç—å 4xx
   - –ì–æ–ª–æ—Å: –∑–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ MediaRecorder ‚Üí –∑–∞–≥—Ä—É–∑–∫–∞, –∑–∞—Ç–µ–º GET/stream –ø–æ URL
6. **–°—Ç–æ—Ä–∏—Å**
   - `POST /api/stories` (photo/video/text), `GET /api/stories`, `POST /api/stories/:id/view`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å-–ª–∏–Ω–∏—é –∏ –∏—Å—Ç–µ—á–µ–Ω–∏–µ `expires_at`
7. **–û–Ω–ª–∞–π–Ω/–æ—Ñ—Ñ–ª–∞–π–Ω –∏ typing (Socket.io)**
   - –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å JWT, —Å–æ–±—ã—Ç–∏–µ `presence:update` –ø—Ä–∏ –≤—Ö–æ–¥–µ/–≤—ã—Ö–æ–¥–µ
   - `typing:start/stop` –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –¥–ª—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
8. **–¢–µ–º—ã/–Ω–µ–æ–Ω –∏ UI**
   - –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å–≤–µ—Ç–ª–æ–π/—Ç—ë–º–Ω–æ–π/–Ω–µ–æ–Ω —Ç–µ–º—ã, blur —ç—Ñ—Ñ–µ–∫—Ç–æ–≤, skeleton –∑–∞–≥—Ä—É–∑–æ–∫
   - –ê–¥–∞–ø—Ç–∏–≤: –±—É—Ä–≥–µ—Ä-–º–µ–Ω—é, –≤—ã–¥–≤–∏–∂–Ω–æ–π sidebar, –º–æ–¥–∞–ª–∫–∏ –Ω–∞ –º–æ–±–∏–ª–µ
9. **–ê–¥–º–∏–Ω –∏ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞**
   - `/admin` —Å—Ç—Ä–∞–Ω–∏—Ü–∞: –≤–∫–ª—é—á–∏—Ç—å maintenance ‚Üí REST –æ—Ç–≤–µ—á–∞–µ—Ç 503 (–∫—Ä–æ–º–µ —Å—Ç–∞—Ç–∏–∫–∏)

## 9) –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Å–∫—Ä–∏–ø—Ç—ã)
–î–∞–∂–µ –±–µ–∑ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç-—Ä–∞–Ω–Ω–µ—Ä–∞, –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª—é—á–µ–≤—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã:
```bash
# Health: SPA –æ—Ç–¥–∞—ë—Ç—Å—è
curl -I http://localhost:3000

# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"name":"Test","email":"test@example.com","password":"Passw0rd!","deviceId":"dev-1"}'

# –õ–æ–≥–∏–Ω
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"Passw0rd!","deviceId":"dev-1"}'
```

–†–∞—Å—à–∏—Ä—è–π—Ç–µ –Ω–∞–±–æ—Ä cURL-–∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –≤—Å–µ—Ö –ø—É–Ω–∫—Ç–æ–≤ —á–µ–∫-–ª–∏—Å—Ç–∞, –≤–∫–ª—é—á–∞—è –∑–∞–≥—Ä—É–∑–∫–∏ (`-F file=@path`).

## 10) –ß—Ç–æ —É—á–∏—Ç—ã–≤–∞—Ç—å –ø—Ä–∏ –ø—Ä–æ–¥–∞–∫—à–Ω-–¥–µ–ø–ª–æ–µ
- PM2: `npm run pm2:start`, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ `pm2 logs`
- Nginx: –ø—Ä–æ–∫—Å–∏ –Ω–∞ –ø–æ—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –ª–∏–º–∏—Ç —Ç–µ–ª–∞ 50 –ú–ë, HTTPS
- –ë—ç–∫–∞–ø—ã –ë–î: –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ `pg_dump`
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: rate limit –∏ –∞–Ω—Ç–∏-—Å–ø–∞–º –ø–æ—Ä–æ–≥–∏, —Ä–æ—Ç–∞—Ü–∏—è JWT-—Å–µ–∫—Ä–µ—Ç–æ–≤

---
–ì–æ—Ç–æ–≤–æ: –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —à–∞–≥–æ–≤ 1‚Äì5 —Å–µ—Ä–≤–∏—Å –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è –Ω–∞ PostgreSQL, –∞ —á–µ–∫-–ª–∏—Å—Ç –∏–∑ –ø—É–Ω–∫—Ç–∞ 8/9 –ø–æ–∫—Ä—ã–≤–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –¢–ó –±–µ–∑ –∑–∞–≥–ª—É—à–µ–∫.
