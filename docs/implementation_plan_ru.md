# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ KOCMOC (PostgreSQL, Node.js/Express, Socket.io)

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç –∏ –∫–ª—é—á–µ–≤—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è, —á—Ç–æ–±—ã –¥–æ–≤–µ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç –¥–æ –ø–æ–ª–Ω–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –¢–ó. –í –Ω—ë–º –Ω–µ—Ç –∑–∞–≥–ª—É—à–µ–∫ ‚Äî —Ç–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏ –∏ –æ–∂–∏–¥–∞–µ–º—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã.

## 1. –ë—ç–∫–µ–Ω–¥ (Node.js + Express + PostgreSQL)
1. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** –ø—Ä–∏–º–µ–Ω–∏—Ç—å `database/schema_postgres.sql` –∫ PostgreSQL. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å `pg`/`pg-pool` –≤ `server/database.js` —Å SSL-–ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∏ retry. –î–æ–±–∞–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –∏–Ω–¥–µ–∫—Å–æ–≤/–∫–æ–ΩSTRAINT–æ–≤, seed –¥–ª—è –¥–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö.
2. **–ú–æ–¥–µ–ª–∏/—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏:** —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–ª–æ–π –¥–æ—Å—Ç—É–ø–∞ (SQL –∏–ª–∏ `pg`-query builder) –¥–ª—è —Ç–∞–±–ª–∏—Ü `users`, `chats`, `chat_members`, `messages`, `stories`, `story_views`. –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ ‚Äî –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö, —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–æ–ª–µ–π (owner/admin/member) –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –¥–ª–∏–Ω—ã —Ç–µ–∫—Å—Ç–∞.
3. **Auth:** –º–∞—Ä—à—Ä—É—Ç—ã `/api/auth/register`, `/login`, `/send-code`, `/verify-code` —Å bcrypt –¥–ª—è –ø–∞—Ä–æ–ª–µ–π, –≤—ã–¥–∞—á–µ–π JWT (access) –∏ email-–∫–æ–¥–∞–º–∏ (6-–∑–Ω–∞—á–Ω—ã–π, TTL). Rate-limit –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ—Å–ª–µ N –Ω–µ–≤–µ—Ä–Ω—ã—Ö –∫–æ–¥–æ–≤/–ø–∞—Ä–æ–ª–µ–π.
4. **Chats:** GET `/api/chats`, `/api/chats/:id`, POST `/api/chats`, `/api/chats/group`. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–ª–µ–Ω—Å—Ç–≤–∞, –∞–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ owner, –ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é. –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî –æ—Ç–¥–∞—ë–º —Å–ø–∏—Å–æ–∫ —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –∏ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º —Å—á—ë—Ç—á–∏–∫–æ–º.
5. **Messages:** GET `/api/chats/:id/messages`, POST `/api/chats/:id/messages`, PATCH `/api/messages/:id/edit`, DELETE `/api/messages/:id/delete`, POST `/api/messages/:id/forward`. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–∏–ø–æ–≤ `text/photo/video/document/audio/sticker`, —Ä–µ–∞–∫—Ü–∏–∏, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –æ—Ç–º–µ—Ç–∫–æ–π `edited`, –º—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ `deleted`. Anti-spam: –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏, –ª–∏–º–∏—Ç –¥–ª–∏–Ω—ã, —Ñ–∏–ª—å—Ç—Ä –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã—Ö mime.
6. **Upload:** POST `/api/upload/file` —Å multer/busboy, –ª–∏–º–∏—Ç 50 –ú–ë, –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ mime, –∑–∞–ø—Ä–µ—Ç `.exe/.bat/.dll`, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –∏–º—ë–Ω –∏ –æ—Ç–¥–∞—á–∞ URL.
7. **Stories:** GET `/api/stories`, POST `/api/stories`, POST `/api/stories/:id/view`. –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –ø–æ `expires_at`, —É—á—ë—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –≤ `story_views` (PK story_id + viewer_id).
8. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** JWT middleware, —Ä–æ–ª—å/—á–ª–µ–Ω—Å—Ç–≤–æ –≤ —á–∞—Ç–∞—Ö, rate limit (per IP + per user), CORS, Helmet, –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ö–µ–º–æ–π (Joi/Zod). –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ request-id. Upload –∑–∞—â–∏—Ç–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤.
9. **–†–µ–∞–ª-—Ç–∞–π–º:** Socket.io —Å–µ—Ä–≤–µ—Ä. –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞/–∫–æ–º–Ω–∞—Ç—ã –ø–æ chatId –∏ userId. –°–æ–±—ã—Ç–∏—è `message:new/edit/delete/forward`, `typing:start/stop`, `presence:update`. JWT-–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ handshake, –∞–Ω—Ç–∏—Ñ–ª—É–¥ (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª), –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–∏. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ lastSeen –∏ online, –æ—Ç–ø—Ä–∞–≤–∫–∞ presence per chat.
10. **–ê–¥–º–∏–Ω:** endpoint/—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è maintenance-—Ä–µ–∂–∏–º–∞, graceful shutdown, health-check `/health` (DB ping + uptime).

## 2. –§—Ä–æ–Ω—Ç–µ–Ω–¥ (UI/UX)
1. **–¢–µ–º—ã:** —Å–≤–µ—Ç–ª–∞—è —Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-–±–µ–ª–∞—è, —Ç—ë–º–Ω–∞—è —Ñ–∏–æ–ª–µ—Ç–æ–≤–æ-—á—ë—Ä–Ω–∞—è, –æ—Ç–¥–µ–ª—å–Ω—ã–π –Ω–µ–æ–Ω (–≥–ª–æ—É). –≠—Ñ—Ñ–µ–∫—Ç liquid glass —Å blur. –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ —Ç–µ–º—ã –∏ –Ω–µ–æ–Ω–∞ –≤ –ª–µ–≤–æ–º —Å–∞–π–¥–±–∞—Ä–µ.
2. **–†–∞–∑–º–µ—Ç–∫–∞:** –ª–µ–≤—ã–π sidebar (–ª–æ–≥–æ—Ç–∏–ø KOCMOC, –ø–æ–∏—Å–∫, stories, —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤, –∫–Ω–æ–ø–∫–∏ ¬´–ù–æ–≤—ã–π —á–∞—Ç¬ª/¬´–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É¬ª, –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏), –ø—Ä–∞–≤–∞—è —á–∞—Å—Ç—å (—à–∞–ø–∫–∞ —Å –∞–≤–∞—Ç–∞—Ä–æ–º/—Å—Ç–∞—Ç—É—Å–æ–º, –ª–µ–Ω—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π, –ø–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ —Å —ç–º–æ–¥–∑–∏/–≤–ª–æ–∂–µ–Ω–∏—è/—Å—Ç–∏–∫–µ—Ä—ã/–≥–æ–ª–æ—Å–æ–≤—ã–µ/–æ—Ç–ø—Ä–∞–≤–∫–∞). –ê–¥–∞–ø—Ç–∏–≤: –±—É—Ä–≥–µ—Ä, –≤—ã–¥–≤–∏–∂–Ω–æ–π —Å–∞–π–¥–±–∞—Ä, –º–æ–±–∏–ª—å–Ω—ã–µ –º–æ–¥–∞–ª–∫–∏/–∏–Ω–ø—É—Ç—ã/–∫–Ω–æ–ø–∫–∏.
3. **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —á–∞—Ç–æ–≤:** —Å–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–æ–≤/–≥—Ä—É–ø–ø, –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ, –∞–≤–∞—Ç–∞—Ä–∫–∏ (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è + –∫–∞—Å—Ç–æ–º), –ø–æ–∏—Å–∫ –ø–æ —á–∞—Ç–∞–º –∏ –≤–Ω—É—Ç—Ä–∏ —á–∞—Ç–∞ —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π, –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä.
4. **–°–æ–æ–±—â–µ–Ω–∏—è:** —Ç–µ–∫—Å—Ç/—Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ/–¥–æ–∫—É–º–µ–Ω—Ç—ã/–≥–æ–ª–æ—Å–æ–≤—ã–µ/—Å—Ç–∏–∫–µ—Ä—ã (PNG/WebP, –∫—Ä—É–ø–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã), —Ä–µ–∞–∫—Ü–∏–∏, –ø–µ—Ä–µ—Å—ã–ª–∫–∞, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ, —ç–º–æ–¥–∑–∏-–ø–∞–Ω–µ–ª—å, skeleton –¥–ª—è —á–∞—Ç–æ–≤/—Å–æ–æ–±—â–µ–Ω–∏–π/–∞–≤–∞—Ç–∞—Ä–æ–≤.
5. **–ì–æ–ª–æ—Å–æ–≤—ã–µ:** –∫–Ω–æ–ø–∫–∞ üé§, –∑–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ MediaRecorder, waveform –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è, –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä, –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ –ø–æ URL.
6. **–í–ª–æ–∂–µ–Ω–∏—è:** –∑–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ `/api/upload/file`, –ª–∏–º–∏—Ç 50 –ú–ë, –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤, –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é/–ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
7. **–°—Ç–æ—Ä–∏—Å:** –∞–≤–∞—Ç–∞—Ä—ã —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–ª–∏–Ω–∏—è–º–∏ (–∫–∞–∫ Telegram), —Ç–∏–ø—ã —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ/—Ç–µ–∫—Å—Ç, –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π viewer, —É—á—ë—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤.
8. **–†–µ–∞–ª-—Ç–∞–π–º:** socket.io –∫–ª–∏–µ–Ω—Ç —Å JWT, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ online/offline, typing indicator, –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π/—Ä–µ–∞–∫—Ü–∏–π/—É–¥–∞–ª–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.
9. **Skeleton/–∞–Ω–∏–º–∞—Ü–∏–∏:** –ø–ª–∞–≤–Ω—ã–µ transitions, skeleton-—ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤/—Å–æ–æ–±—â–µ–Ω–∏–π/–∞–≤–∞—Ç–∞—Ä–æ–≤.

## 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- Unit-—Ç–µ—Å—Ç—ã –¥–ª—è auth, —á–∞—Ç–æ–≤, —Å–æ–æ–±—â–µ–Ω–∏–π, stories, upload –≤ Node.js (Jest). –ú–æ–∫–∏ –ë–î –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å —Ç–µ—Å—Ç–æ–≤–æ–π PostgreSQL (docker-compose). E2E –¥–ª—è socket.io (handshake + —Å–æ–±—ã—Ç–∏—è) –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –∞–Ω—Ç–∏—Ñ–ª—É–¥–∞. –¢–µ—Å—Ç—ã MediaRecorder/–≤–ª–æ–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ jsdom + —ç–º—É–ª—è—Ü–∏—è —Ñ–∞–π–ª–æ–≤.

## 4. –î–µ–ø–ª–æ–π
- Dockerfile —Å Node.js 18+, multi-stage build. docker-compose —Å PostgreSQL –∏ nginx. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å `ecosystem.config.js` –¥–ª—è PM2 (graceful reload). Nginx: gzip/brotli, –≤–µ–±—Å–æ–∫–µ—Ç—ã, –ª–∏–º–∏—Ç—ã upload. CI: lint/test, –º–∏–≥—Ä–∞—Ü–∏–∏, –≤—ã–∫–ª–∞–¥–∫–∞. Rollback —á–µ—Ä–µ–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ–±—Ä–∞–∑.

## 5. –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–±–ª–∏–∂–∞–π—à–∏–π —Å–ø—Ä–∏–Ω—Ç)
1. –ü–æ–¥–∫–ª—é—á–∏—Ç—å PostgreSQL –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –º–∞—Ä—à—Ä—É—Ç–∞–º –≤ `server/routes`, –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å Mongo-–∑–∞–ø—Ä–æ—Å—ã –Ω–∞ SQL/`pg` —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏.
2. –î–æ–±–∞–≤–∏—Ç—å JWT middleware –∏ rate-limit –Ω–∞ –≤—Å–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã, –≤–Ω–µ–¥—Ä–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ä–æ–ª–µ–π –≤ —á–∞—Ç–∞—Ö.
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Socket.io —Å–ª–æ–π (presence, typing, —Å–æ–±—ã—Ç–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π) —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π JWT –∏ –∞–Ω—Ç–∏—Ñ–ª—É–¥–æ–º.
4. –û–±–Ω–æ–≤–∏—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥: —Ç–µ–º—ã, –Ω–µ–æ–Ω, liquid glass, —Å—Ç–æ—Ä–∏—Å, –≥–æ–ª–æ—Å–æ–≤—ã–µ, –∑–∞–≥—Ä—É–∑–∫–∏, skeleton –∏ –∞–¥–∞–ø—Ç–∏–≤. –°–≤—è–∑–∞—Ç—å —Å REST + Socket.io.
5. –ù–∞–ø–∏—Å–∞—Ç—å –∞–≤—Ç–æ-—Ç–µ—Å—Ç—ã –∏ docker-compose –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ (PostgreSQL + —Å–µ—Ä–≤–µ—Ä + —Ñ—Ä–æ–Ω—Ç), –æ–ø–∏—Å–∞—Ç—å –≤ README.
